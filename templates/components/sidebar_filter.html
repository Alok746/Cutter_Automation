<script id="filterData_{{ question_code }}_filter" type="application/json">
{
  "questions": {{ request.form.getlist("filter_question") | tojson | safe }},
  "values": {{ request.form.getlist("filter_value") | tojson | safe }}
}
</script>

<script id="allColumnsData_{{ question_code }}_filter" type="application/json">
  {{ all_columns | tojson | safe }}
</script>

<div id="sidebar_{{ question_code }}_filter" class="sidebar">
  <button type="button" onclick="addFilter('{{ question_code }}_filter')">+ Add Filter</button>

  <form method="post" action="{{ request.path }}">
    <input type="hidden" name="filename" value="{{ filename }}">
    <input type="hidden" name="sheet" value="{{ sheet }}">
    <input type="hidden" name="column" value="{{ question_code }}">

    <div id="filters_{{ question_code }}_filter"></div>

    <hr>
    <h3>Sort Table</h3>
    <label for="sort_order_{{ question_code }}">Sort by % of respondents:</label><br>
    <select name="sort_order" id="sort_order_{{ question_code }}">
      <option value="none" {% if sort_order == 'none' %}selected{% endif %}>None</option>
      <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
      <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
    </select><br><br>

    {% if sort_column_options %}
    <div id="sort_column_container_{{ question_code }}_filter" style="display: none;">
      <label for="sort_column_{{ question_code }}">Sort column:</label><br>
      <select name="sort_column" id="sort_column_{{ question_code }}">
        {% for col in sort_column_options %}
        <option value="{{ col }}" {% if sort_column == col %}selected{% endif %}>{{ col }}</option>
        {% endfor %}
      </select><br><br>
    </div>
    {% endif %}

    <button type="submit">Go</button>
  </form>
</div>

<script>
function addFilter(qid) {
  const allColumns = JSON.parse(document.getElementById("allColumnsData_" + qid).textContent);
  const filtersDiv = document.getElementById("filters_" + qid);
  const index = filtersDiv.childElementCount + 1;

  const block = document.createElement("div");
  block.className = "filter-block";
  block.style.marginTop = "15px";

  const label = document.createElement("label");
  label.innerText = `Filter ${index}`;
  block.appendChild(label);
  block.appendChild(document.createElement("br"));

  const questionSelect = document.createElement("select");
  questionSelect.name = "filter_question";
  questionSelect.className = "question-dropdown";
  questionSelect.onchange = function () {
    loadValues(questionSelect, valueSelect, qid);
  };
  questionSelect.appendChild(new Option("-- Select Question --", ""));
  allColumns.forEach(col => {
    questionSelect.appendChild(new Option(col, col));
  });

  block.appendChild(questionSelect);
  block.appendChild(document.createElement("br"));
  block.appendChild(document.createElement("br"));

  const valueSelect = document.createElement("select");
  valueSelect.name = "filter_value";
  valueSelect.innerHTML = `<option value="__all__">All</option>`;
  block.appendChild(valueSelect);

  filtersDiv.appendChild(block);
}

function loadValues(questionSelect, valueSelect, qid) {
  const question = questionSelect.value;
  const filename = document.querySelector("input[name='filename']").value;

  if (!question) return;

  fetch("/get_answer_key_values", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ filename, question })
  })
  .then(response => response.json())
  .then(data => {
    console.log("Received filter values:", data);
    valueSelect.innerHTML = `<option value="__all__">All</option>`;
    data.forEach(value => {
      const opt = document.createElement("option");
      opt.value = value;
      opt.text = value;
      valueSelect.appendChild(opt);
    });
  });
}
</script>